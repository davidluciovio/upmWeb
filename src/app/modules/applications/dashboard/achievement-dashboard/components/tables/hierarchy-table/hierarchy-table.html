<section
	[class.h-[500px]]="viewMode() === 'table'"
	[class.min-h-[500px]]="viewMode() === 'chart'"
	class="bg-base-100 rounded-xl shadow-sm border border-base-300 overflow-hidden flex flex-col"
>
	<div class="p-4 bg-base-100 border-b flex flex-col gap-4">
		<div class="flex justify-between items-center">
			<div>
				<h2 class="text-xs font-bold uppercase tracking-widest text-base-content italic">Hierarchy Performance / 役職別</h2>
				<span class="text-[0.7rem] text-base-content/60 font-normal block">Análisis de Supervisores y Líderes</span>
			</div>

			<div class="flex rounded-md border border-base-300 bg-base-100 p-1">
				<button
					(click)="viewMode.set('table')"
					[class.bg-[#002855]]="viewMode() === 'table'"
					[class.text-white]="viewMode() === 'table'"
					class="px-3 py-1 text-[9px] font-bold uppercase rounded transition-colors"
				>
					Tabla
				</button>
				<button
					(click)="viewMode.set('chart')"
					[class.bg-[#002855]]="viewMode() === 'chart'"
					[class.text-white]="viewMode() === 'chart'"
					class="px-3 py-1 text-[9px] font-bold uppercase rounded transition-colors"
				>
					Gráfica
				</button>
			</div>
		</div>

		<div class="relative">
			<input
				type="text"
				[ngModel]="searchText()"
				(ngModelChange)="searchText.set($event)"
				placeholder="Buscar por nombre... / 検索..."
				class="w-full bg-base-100 border border-base-300 rounded-lg py-1.5 pl-8 pr-4 text-xs focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
			/>
			<svg class="absolute left-2.5 top-2 h-3.5 w-3.5 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
			</svg>
		</div>
	</div>

	@if (viewMode() === 'table') {
		<div class="overflow-auto grow custom-scrollbar">
			<table class="w-full text-left text-xs border-collapse">
				<thead class="bg-base-200 border-b text-base-content/60 sticky top-0 z-10">
					<tr>
						<th class="w-10 px-4 py-3"></th>
						<th class="py-3 font-bold uppercase text-[9px] cursor-pointer hover:text-primary transition-colors group/head" (click)="toggleSort('name')">
							<div class="flex items-center gap-1">
								Responsable / 担当者
								<svg
									class="h-3 w-3 transition-opacity"
									[class.opacity-0]="sortField() !== 'name'"
									[class.rotate-180]="sortField() === 'name' && sortOrder() === 'desc'"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path d="M5 15l7-7 7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
								</svg>
							</div>
						</th>
						<th class="py-3 font-bold uppercase text-[9px] cursor-pointer hover:text-primary transition-colors group/head" (click)="toggleSort('area')">
							<div class="flex items-center gap-1">
								Area / 部門
								<svg
									class="h-3 w-3 transition-opacity"
									[class.opacity-0]="sortField() !== 'area'"
									[class.rotate-180]="sortField() === 'area' && sortOrder() === 'desc'"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path d="M5 15l7-7 7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
								</svg>
							</div>
						</th>
						<th
							class="py-3 text-center font-bold uppercase text-[9px] cursor-pointer hover:text-primary transition-colors group/head"
							(click)="toggleSort('ach')"
						>
							<div class="flex items-center justify-center gap-1">
								Achievement / 達成率
								<svg
									class="h-3 w-3 transition-opacity"
									[class.opacity-0]="sortField() !== 'ach'"
									[class.rotate-180]="sortField() === 'ach' && sortOrder() === 'desc'"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path d="M5 15l7-7 7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
								</svg>
							</div>
						</th>
						<th class="py-3 text-center font-bold uppercase text-[9px]">Action / 操作</th>
					</tr>
				</thead>
				<tbody class="divide-y divide-slate-100">
					@for (sup of filteredData(); track sup.name) {
						<tr class="hover:bg-base-200/50 transition-colors group">
							<td class="text-center py-3">
								<button (click)="toggleExpand(sup.name)" class="p-1 hover:bg-base-300 rounded transition-colors">
									<svg
										class="h-3 w-3 text-base-content/40 transition-transform duration-200"
										[class.rotate-90]="isExpanded(sup.name)"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24"
									>
										<path d="M9 5l7 7-7 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
									</svg>
								</button>
							</td>
							<td class="py-3 font-bold text-base-content cursor-pointer" (click)="toggleExpand(sup.name)">
								{{ sup.name }}
							</td>
							<td class="py-3">
								<span class="text-[10px] uppercase text-base-content/60 font-bold px-2 py-0.5 bg-base-200 rounded">
									{{ sup.area }}
								</span>
							</td>
							<td class="py-3 text-center">
								<span
									class="px-2 py-1 rounded-full font-black text-[10px]"
									[ngClass]="sup.ach >= 100 ? 'bg-green-500/10 text-green-500' : 'bg-orange-500/10 text-orange-500'"
								>
									{{ sup.ach | number: '1.1-1' }}%
								</span>
							</td>
							<td class="py-3 text-center">
								<button
									(click)="triggerDetail(sup.name, sup.records)"
									class="dbtn dbtn-xs dbtn-ghost text-primary hover:text-primary-content hover:bg-primary"
								>
									DETALLES
								</button>
							</td>
						</tr>

						@if (isExpanded(sup.name)) {
							@for (lid of sup.leaders; track lid.name) {
								<tr class="bg-base-200/30 border-l-4 border-primary animate-fadeIn">
									<td></td>
									<td class="pl-6 py-2 text-[11px] text-base-content/70 italic"><span class="text-base-content/30 mr-2">↳</span>{{ lid.name }}</td>
									<td class="py-2"></td>
									<td class="py-2 text-center font-semibold text-base-content/60">{{ lid.ach | number: '1.1-1' }}%</td>
									<td class="py-2 text-center text-[10px]">
										<button
											(click)="triggerDetail(lid.name, lid.records)"
											class="dbtn dbtn-xs dbtn-ghost text-primary hover:text-primary-content hover:bg-secondary"
										>
											LOG
										</button>
									</td>
								</tr>
							}
						}
					} @empty {
						<tr>
							<td colspan="4" class="py-10 text-center text-base-content/40 italic text-xs">No se encontraron resultados...</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	} @else {
		<div class="p-2 grow">
			<chart [chartOptions]="hierarchyChartOptions()"></chart>
		</div>
	}
</section>
