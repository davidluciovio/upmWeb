<section class="bg-base-100 rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
	<div class="p-4 bg-base-200 border-b flex flex-col gap-4">
		<div class="flex justify-between items-center">
			<div>
				<h2 class="text-xs font-bold uppercase tracking-widest text-slate-600 italic">Hierarchy Performance / 役職別</h2>
				<span class="text-[0.7rem] text-slate-400 font-normal block">管理者およびリーダーの分析</span>
			</div>
			<!-- View Toggles -->
			<div class="flex rounded border border-slate-300 bg-white p-1">
				<button
					(click)="setView('table')"
					class="px-3 py-1 text-[9px] font-bold uppercase rounded transition-all"
					[class]="viewMode() === 'table' ? 'bg-[#002855] text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'"
				>
					Table
				</button>
				<button
					(click)="setView('chart')"
					class="px-3 py-1 text-[9px] font-bold uppercase rounded transition-all"
					[class]="viewMode() === 'chart' ? 'bg-[#002855] text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'"
				>
					Chart
				</button>
			</div>
		</div>

		<!-- Search (Visible only in Table mode for now, or always? index.html shows it always) -->
		<div class="relative">
			<input
				type="text"
				[ngModel]="searchText()"
				(ngModelChange)="onSearch($event)"
				placeholder="Buscar Supervisor/Líder... / 検索..."
				class="dinput dinput-bordered dinput-xs w-full pl-8"
			/>
			<svg class="absolute left-2.5 top-1.5 h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
			</svg>
		</div>
	</div>

	<!-- Table View -->
	<div *ngIf="viewMode() === 'table'" class="overflow-x-auto flex-grow">
		<table class="dtable w-full text-left text-xs">
			<thead class="bg-base-100 border-b text-slate-400 font-bold uppercase text-[9px] sticky top-0 z-10 shadow-sm">
				<tr>
					<th class="w-8"></th>
					<th>Responsable / 担当者</th>
					<th class="text-center">Achievement / 達成率</th>
					<th class="text-center">Action / 操作</th>
				</tr>
			</thead>
			<tbody>
				<ng-container *ngFor="let sup of filteredData()">
					<tr class="hover:bg-base-200 transition-colors border-b border-base-200">
						<td class="text-center cursor-pointer" (click)="toggleExpand(sup)">
							<svg
								class="h-3 w-3 text-slate-400 transition-transform duration-200"
								[class.rotate-90]="sup.expanded"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path d="M9 5l7 7-7 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
							</svg>
						</td>
						<td class="font-bold text-slate-800 uppercase cursor-pointer" (click)="toggleExpand(sup)">{{ sup.name }}</td>
						<td class="text-center font-black" [class.text-emerald-600]="sup.ach >= 100" [class.text-amber-600]="sup.ach < 100">
							{{ sup.ach | number: '1.1-1' }}%
						</td>
						<td class="text-center">
							<button
								(click)="triggerDetail(sup.name, sup.records)"
								class="text-[9px] font-bold text-blue-600 border border-blue-200 px-3 py-1 rounded-lg bg-blue-50 hover:bg-blue-600 hover:text-white transition-all"
							>
								DETALLE
							</button>
						</td>
					</tr>
					<ng-container *ngIf="sup.expanded">
						<tr *ngFor="let lid of sup.leaders" class="bg-base-200/50 border-l-4 border-[#002855]">
							<td></td>
							<td class="pl-8 text-xs text-slate-600 uppercase font-medium">{{ lid.name }}</td>
							<td class="text-center font-bold text-emerald-600">{{ lid.ach | number: '1.1-1' }}%</td>
							<td class="text-center">
								<button
									(click)="triggerDetail(lid.name, lid.records)"
									class="text-[8px] font-bold text-slate-400 border border-slate-200 px-2 py-0.5 rounded bg-white hover:bg-slate-700 hover:text-white transition-all"
								>
									LOG
								</button>
							</td>
						</tr>
					</ng-container>
				</ng-container>
			</tbody>
		</table>
	</div>

	<!-- Chart View -->
	<div *ngIf="viewMode() === 'chart'" class="p-4 flex-grow overflow-auto h-[400px]">
		<chart [chartOptions]="hierarchyChartOptions()"></chart>
	</div>
</section>
