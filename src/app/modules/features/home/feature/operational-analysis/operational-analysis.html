@if (!isPresentationMode()) {
	<div class="main-content-layout">
		<filter-bar
			class="filter-bar-sticky"
			(filters)="onFiltersChange($event)"
			(onSyncClick)="onSync()"
			(onPresentationModeClick)="isPresentationMode.set(true)"
			[isSyncing]="_loadData.isProcessing()"
		></filter-bar>

		<p-dialog
			header="Sincronizando Datos"
			[(visible)]="showSyncDialog"
			[modal]="true"
			[closable]="!_loadData.isProcessing()"
			[style]="{ width: '50vw' }"
			[breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
		>
			<div #logContainer class="log-viewer-container">
				@for (log of _loadData.logs(); track $index) {
					<div class="log-entry">
						<span class="log-index">[{{ $index + 1 }}]</span> {{ log }}
					</div>
				} @empty {
					<div class="log-empty">Iniciando sincronización...</div>
				}
				@if (_loadData.isProcessing()) {
					<div class="sync-processing">
						<i class="pi pi-spin pi-spinner"></i>
						<span>Procesando...</span>
					</div>
				}
			</div>
		</p-dialog>
		@if (data$.isLoading()) {
			<div class="loading-state-container">
				<p-progressSpinner strokeWidth="4" fill="transparent" animationDuration=".8s"></p-progressSpinner>
				<span class="loading-text">Cargando datos...</span>
			</div>
		} @else {
			@if (data$.hasValue() && data$.value().cards.length > 0) {
				<div class="cards-display-grid">
					@for (item of data$.value().cards; track item.area) {
						<app-operativity-card [cardData]="item" class="card-entry-animation" [style.animation-delay]="$index * 100 + 'ms'" />
					}
				</div>
				<div class="tables-display-grid">
					<app-supervisor-table-operativity
						[supervisorData]="data$.value().managments"
						class="supervisor-table-span"
						style="animation-delay: 500ms"
						(viewDailyDetail)="onOpenSupervisorDetail($event)"
					></app-supervisor-table-operativity>
					<app-partnumber-table-operativity
						[partnumberData]="data$.value().partNumbers"
						class="partnumber-table-span"
						style="animation-delay: 500ms"
						(openDetail)="onOpenDetail($event)"
					></app-partnumber-table-operativity>
				</div>
				<app-annual-area-trend-chart
					[data]="data$.value().annualAreaTrends"
					class="fade-in-up-container"
					style="animation-delay: 700ms"
				></app-annual-area-trend-chart>
				<div class="rankings-display-grid">
					<!-- Managers Ranking -->
					<app-ranking-chart [managments]="data$.value().managments" level="manager" title="Gerentes" color="#4f46e5"></app-ranking-chart>

					<!-- Jefes Ranking -->
					<app-ranking-chart [managments]="data$.value().managments" level="jefe" title="Jefes" color="#10b981"></app-ranking-chart>

					<!-- Supervisors Ranking -->
					<app-ranking-chart
						class="span-two-cols"
						[managments]="data$.value().managments"
						level="supervisor"
						title="Supervisores"
						color="#0ea5e9"
					></app-ranking-chart>

					<!-- Leaders Ranking -->
					<app-ranking-chart
						class="span-two-cols"
						[managments]="data$.value().managments"
						level="leader"
						title="Líderes"
						color="#64748b"
					></app-ranking-chart>
				</div>
				<app-area-trend-chart-operativity
					[data]="data$.value().areaOperativityDayTrends"
					class="fade-in-up-container"
					style="animation-delay: 500ms"
				></app-area-trend-chart-operativity>
			} @else {
				<div class="empty-state-container">
					<p-message severity="info" text="No se encontraron datos para los filtros seleccionados." styleClass="empty-message-info"></p-message>
				</div>
			}
		}
	</div>
} @else {
	<!-- Presentation Overlay (Formal Style) -->
	<div class="presentation-overlay">
		<!-- Header -->
		<div class="presentation-header">
			<div class="header-logo-section">
				<img src="images/logoUnipres_color.webp" alt="Logo" class="logo-image" onerror="this.style.display='none'" />
				<div class="header-divider"></div>
				<div>
					<h1 class="header-title">Análisis Operativo</h1>
				</div>
			</div>
			<div class="header-actions">
				<div class="controls-group">
					<!-- Play/Pause Toggle -->
					<button
						pButton
						class="p-button-rounded p-button-outlined p-button-secondary control-btn"
						(click)="toggleAutoplay()"
						[pTooltip]="isAutoplayPaused() ? 'Reanudar Reproducción' : 'Pausar Reproducción'"
					>
						<span class="material-symbols-outlined">{{ isAutoplayPaused() ? 'play_arrow' : 'pause' }}</span>
					</button>

					<!-- Duration Selector -->
					<div class="duration-control">
						<span class="duration-label">Velocidad:</span>
						<p-select
							[options]="durationOptions"
							[ngModel]="slideDuration()"
							(onChange)="onDurationChange($event)"
							optionLabel="label"
							optionValue="value"
							styleClass="duration-select-prime"
						></p-select>
					</div>
				</div>

				<div class="header-divider-alt"></div>

				<button pButton class="p-button-rounded p-button-text p-button-secondary close-button" (click)="isPresentationMode.set(false)">
					<span class="material-symbols-outlined icon-mr">close</span>
					<span class="font-bold">Cerrar</span>
				</button>
			</div>
		</div>

		<!-- Content -->
		<div class="presentation-content">
			@if (data$.isLoading()) {
				<div class="loading-state-container">
					<p-progressSpinner strokeWidth="4" fill="transparent" animationDuration=".8s"></p-progressSpinner>
					<span class="loading-text">Cargando datos de presentación...</span>
				</div>
			} @else if (carouselItems().length > 0) {
				<p-carousel
					[value]="carouselItems()"
					[numVisible]="1"
					[numScroll]="1"
					[circular]="true"
					[showIndicators]="true"
					[showNavigators]="true"
					[autoplayInterval]="activeAutoplayInterval()"
					styleClass="custom-carousel"
				>
					<ng-template let-item pTemplate="item">
						<div class="carousel-slide">
							<h2 class="slide-header">
								{{ item.title }}
							</h2>

							<div class="slide-body">
								<!-- Clean Container for Slide Content -->
								<div class="slide-content-wrapper">
									<div class="slide-content-inner">
										@switch (item.type) {
											@case ('cards') {
												<div class="slide-cards-summary-container">
													<div class="cards-flex-wrap">
														@for (card of item.data; track card.area) {
															<app-operativity-card [cardData]="card" />
														}
													</div>
												</div>
											}
											@case ('supervisor-table') {
												<div class="slide-cards-summary-container">
													<app-supervisor-table-operativity
														[supervisorData]="item.data"
														class="width-full"
														(viewDailyDetail)="onOpenSupervisorDetail($event)"
													></app-supervisor-table-operativity>
												</div>
											}
											@case ('part-number-table') {
												<div class="slide-cards-summary-container">
													<app-partnumber-table-operativity
														[partnumberData]="item.data"
														class="width-full"
														(openDetail)="onOpenDetail($event)"
													></app-partnumber-table-operativity>
												</div>
											}
											@case ('ranking-manager') {
												<div class="ranking-slide-wrapper">
													<div class="ranking-chart-container">
														<app-ranking-chart [managments]="item.data" level="manager" title="Gerentes" color="#4f46e5"></app-ranking-chart>
													</div>
												</div>
											}
											@case ('ranking-jefe') {
												<div class="ranking-slide-wrapper">
													<div class="ranking-chart-container">
														<app-ranking-chart [managments]="item.data" level="jefe" title="Jefes" color="#10b981"></app-ranking-chart>
													</div>
												</div>
											}
											@case ('ranking-supervisor') {
												<div class="ranking-slide-wrapper">
													<div class="ranking-chart-container">
														<app-ranking-chart [managments]="item.data" level="supervisor" title="Supervisores" color="#0ea5e9"></app-ranking-chart>
													</div>
												</div>
											}
											@case ('ranking-leader') {
												<div class="ranking-slide-wrapper">
													<div class="ranking-chart-container">
														<app-ranking-chart [managments]="item.data" level="leader" title="Líderes" color="#64748b"></app-ranking-chart>
													</div>
												</div>
											}
											@case ('annual-trend') {
												<div class="trend-slide-wrapper">
													<app-annual-area-trend-chart class="width-height-full" [data]="item.data"></app-annual-area-trend-chart>
												</div>
											}
											@case ('area-trend') {
												<div class="trend-slide-wrapper">
													<app-area-trend-chart-operativity class="width-height-full" [data]="item.data"></app-area-trend-chart-operativity>
												</div>
											}
										}
									</div>
								</div>
							</div>
						</div>
					</ng-template>
				</p-carousel>
			} @else {
				<div class="empty-state-container">
					<p-message severity="info" text="No hay datos disponibles para mostrar en la presentación." styleClass="empty-message-info"></p-message>
				</div>
			}
		</div>
	</div>
}

<app-part-number-detail-modal [(visible)]="showDetailModal" [partNumber]="selectedPartNumber()" [filters]="filters()"></app-part-number-detail-modal>

<app-supervisor-detail-modal
	[(visible)]="showSupervisorDetailModal"
	[data]="selectedSupervisorData()"
	[filters]="filters()"
></app-supervisor-detail-modal>
