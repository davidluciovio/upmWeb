<div class="flex flex-col gap-4">
	<div
		class="flex justify-between items-center bg-surface-0 dark:bg-surface-900 p-4 rounded-xl border border-surface-200 dark:border-surface-700 shadow-sm"
	>
		<div class="flex items-center gap-3">
			<div class="p-2 bg-primary-100 dark:bg-primary-900/30 rounded-lg text-primary">
				<span class="material-symbols-outlined leading-none">account_tree</span>
			</div>
			<div>
				<h2 class="text-xl font-bold text-surface-900 dark:text-surface-0">Estructura de Partes</h2>
				<p class="text-sm text-surface-500">Visualice y administre la relación entre productos y componentes</p>
			</div>
		</div>
		<p-toggleButton
			[ngModel]="viewMode() === 'tree'"
			(ngModelChange)="toggleView()"
			[onLabel]="'Vista Árbol'"
			offLabel="Vista Tabla"
			offIcon="pi pi-table"
			styleClass="w-36"
		></p-toggleButton>
	</div>

	@if (!structures$.isLoading()) {
		@if (structures$.hasValue()) {
			<div [ngClass]="{ hidden: viewMode() !== 'table' }">
				<table-crud
					[data]="structures$.value()"
					[columns]="columns"
					(create)="createStructure()"
					(edit)="editStructure($event)"
					(delete)="deleteStructure($event)"
				></table-crud>
			</div>

			<div
				[ngClass]="{ hidden: viewMode() !== 'tree' }"
				class="bg-surface-0 dark:bg-surface-900 rounded-xl border border-surface-200 dark:border-surface-700 shadow-sm overflow-hidden"
			>
				<p-treeTable [value]="treeData()" [scrollable]="true" scrollHeight="calc(100vh - 350px)" styleClass="p-treetable-sm">
					<ng-template pTemplate="header">
						<tr class="bg-surface-50 dark:bg-surface-800">
							<th class="w-1/3">Nombre / Producto</th>
							<th class="w-1/4">Descripción / Modelo</th>
							<th>Proveedor</th>
							<th class="w-32">Estado</th>
							<th class="w-32 text-center">Acciones</th>
						</tr>
					</ng-template>
					<ng-template pTemplate="body" let-rowNode let-rowData="rowData">
						<tr [ttRow]="rowNode" class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors">
							<td>
								<div class="flex items-center gap-1">
									<p-treeTableToggler [rowNode]="rowNode" />
									<span
										[ngClass]="{
											'font-bold text-primary-600 dark:text-primary-400': rowData.isStation,
											'text-surface-700 dark:text-surface-200': !rowData.isStation,
										}"
									>
										{{ rowData.name }}
									</span>
									@if (rowData.isStation) {
										<p-tag severity="info" value="Producto" [rounded]="true" class="scale-75 origin-left" />
									}
								</div>
							</td>
							<td>
								<span class="text-sm" [ngClass]="rowData.isStation ? 'text-surface-500 font-medium' : 'text-surface-400'">
									{{ rowData.description }}
								</span>
							</td>
							<td>
								<span class="text-sm text-surface-600 dark:text-surface-300">
									{{ rowData.supplier || '--' }}
								</span>
							</td>
							<td>
								@if (!rowData.isStation) {
									<p-tag [severity]="rowData.active ? 'success' : 'danger'" [value]="rowData.active ? 'Activo' : 'Inactivo'" [rounded]="true" />
								}
							</td>
							<td>
								<div class="flex justify-center gap-1">
									@if (!rowData.isStation) {
										<p-button
											icon="pi pi-pencil"
											[text]="true"
											[rounded]="true"
											severity="secondary"
											size="small"
											(onClick)="editStructure(rowData.original)"
											pTooltip="Editar Componente"
										/>
										<p-button
											icon="pi pi-trash"
											[text]="true"
											[rounded]="true"
											severity="danger"
											size="small"
											(onClick)="deleteStructure(rowData.original)"
											pTooltip="Eliminar Componente"
										/>
									} @else {
										<p-button
											icon="pi pi-plus"
											[text]="true"
											[rounded]="true"
											severity="primary"
											size="small"
											(onClick)="createStructureFromStation(rowData.stationId)"
											pTooltip="Añadir Componente"
										/>
									}
								</div>
							</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="emptymessage">
						<tr>
							<td colspan="5" class="text-center p-8 text-surface-400 italic">No hay estructuras configuradas</td>
						</tr>
					</ng-template>
				</p-treeTable>
			</div>
		}
	} @else {
		<div
			class="flex flex-col items-center justify-center p-20 bg-surface-0 dark:bg-surface-900 rounded-xl border border-surface-200 dark:border-surface-700 shadow-sm"
		>
			<span class="dloading dloading-spinner dloading-lg text-primary"></span>
			<span class="mt-4 text-lg font-semibold text-surface-600 dark:text-surface-300 animate-pulse">Cargando estructuras...</span>
		</div>
	}
</div>

<p-dialog
	[(visible)]="dialogVisible"
	[modal]="true"
	[style]="{ width: '450px' }"
	[header]="isEditMode ? 'Editar Estructura' : 'Agregar Estructura'"
	[draggable]="false"
	[resizable]="false"
	styleClass="p-fluid bg-surface-50 dark:bg-surface-900"
>
	<div [formGroup]="form" class="flex flex-col gap-6 mt-2">
		<!-- Section: Parent Product (Station) -->
		<div class="p-4 bg-indigo-50/50 dark:bg-indigo-900/10 rounded-xl border border-indigo-100 dark:border-indigo-800/50 flex flex-col gap-4">
			<div class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400">
				<span class="material-symbols-outlined text-sm">inventory_2</span>
				<span class="text-xs font-bold uppercase tracking-wider">Producto Terminado (Estación)</span>
			</div>

			<div class="flex flex-col gap-2">
				<label for="station" class="text-sm font-medium text-surface-600 dark:text-surface-200">Seleccione el numero de parte completo</label>
				<p-select
					id="station"
					formControlName="productionStationId"
					[options]="stationOptions()"
					optionLabel="label"
					optionValue="id"
					placeholder="Buscar estación..."
					[filter]="true"
					filterBy="label"
					[loading]="stations$.isLoading()"
					appendTo="body"
					styleClass="w-full"
				></p-select>
			</div>
		</div>

		<!-- Section: Child Component (Logistics) -->
		<div class="p-4 bg-emerald-50/50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-800/50 flex flex-col gap-4">
			<div class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400">
				<span class="material-symbols-outlined text-sm">widgets</span>
				<span class="text-xs font-bold uppercase tracking-wider">Componente (Logística)</span>
			</div>

			<div class="flex flex-col gap-2">
				<label for="logistic" class="text-sm font-medium text-surface-600 dark:text-surface-200">Parte que lo compone</label>
				<p-select
					id="logistic"
					formControlName="partNumberLogisticId"
					[options]="pnLogisticOptions()"
					optionLabel="label"
					optionValue="id"
					placeholder="Buscar parte logística..."
					[filter]="true"
					filterBy="label"
					[loading]="pnLogistics$.isLoading()"
					appendTo="body"
					styleClass="w-full"
				></p-select>
			</div>

			<div class="grid grid-cols-2 gap-4">
				<div class="flex flex-col gap-2">
					<label for="pnName" class="text-xs font-medium text-surface-500">Núm. Parte</label>
					<input
						pInputText
						id="pnName"
						formControlName="partNumberName"
						[readonly]="true"
						placeholder="Automático"
						class="p-inputtext-sm bg-surface-100/50"
					/>
				</div>
				<div class="flex flex-col gap-2">
					<label for="pnDesc" class="text-xs font-medium text-surface-500">Descripción</label>
					<input
						pInputText
						id="pnDesc"
						formControlName="partNumberDescription"
						[readonly]="true"
						placeholder="Automático"
						class="p-inputtext-sm bg-surface-100/50"
					/>
				</div>
			</div>
		</div>

		<!-- Section: Supplier Details -->
		<div class="flex flex-col gap-4">
			<div class="flex flex-col gap-2">
				<label for="supplier" class="font-medium text-surface-600 dark:text-surface-200">Proveedor de Material</label>
				<p-select
					id="supplier"
					formControlName="materialSuplierId"
					[options]="suppliers$.value()"
					optionLabel="materialSupplierDescription"
					optionValue="id"
					placeholder="Seleccione proveedor..."
					[filter]="true"
					filterBy="materialSupplierDescription"
					[loading]="suppliers$.isLoading()"
					appendTo="body"
					styleClass="w-full"
				></p-select>
			</div>

			<div class="flex items-center justify-between bg-surface-50 dark:bg-surface-800 p-3 rounded-xl border border-surface-200 dark:border-surface-700">
				<div class="flex items-center gap-2">
					<p-toggleSwitch inputId="active" formControlName="active"></p-toggleSwitch>
					<label for="active" class="font-medium text-surface-700 dark:text-surface-100">Registro Activo</label>
				</div>
			</div>
		</div>
	</div>

	<ng-template pTemplate="footer">
		<div class="flex justify-end gap-2 mt-4">
			<p-button label="Cancelar" icon="pi pi-times" [text]="true" severity="secondary" (onClick)="closeModal()"></p-button>
			<p-button label="Guardar" icon="pi pi-check" severity="primary" (onClick)="save()" [disabled]="form.invalid"></p-button>
		</div>
	</ng-template>
</p-dialog>
